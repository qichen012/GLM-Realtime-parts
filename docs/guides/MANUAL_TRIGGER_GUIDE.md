# 🎯 手动触发模式使用指南

## 📊 问题背景

从日志分析发现，Server VAD 在以下情况下无法正常检测到语音结束：
- 环境有持续的背景噪音
- 麦克风灵敏度太高
- 即使降低到 700ms 静音检测，仍然无法触发

## ✨ 解决方案：手动触发模式

添加了**空格键手动触发**功能，让你主动告诉系统"我说完了"。

## 🎮 使用方法

### 运行程序

```bash
python run_with_agent_02.py
```

### 对话流程

1. **开始说话** 🎤
   ```
   说：「帮我规划一个去北京的旅行」
   ```

2. **按空格键** ⌨️
   ```
   说完后，按一下空格键
   ```
   
   程序会显示：
   ```
   🔔 [空格键] 手动触发语音结束...
      ✅ 已手动触发，等待 AI 回复...
   ```

3. **等待 AI 回复** 🤖
   - AI 会开始生成回复
   - 你会听到甜美女声（1.5倍速）

4. **（可选）打断 AI** 
   - 如果想打断 AI 说话，按回车键

## ⌨️ 快捷键说明

| 按键 | 功能 | 说明 |
|------|------|------|
| **空格键 (Space)** | 表示说完 | 手动触发 AI 开始处理你的语音 |
| **回车键 (Enter)** | 打断 AI | 中断 AI 的回复，立即停止 |
| **Ctrl+C** | 退出 | 结束程序 |

## 🔍 日志说明

启用手动触发后，日志中会出现：

```
[MANUAL] 用户按下空格键，准备手动触发语音结束
[MANUAL] 手动触发：清空音频缓冲并请求响应
[WS_SEND] 手动提交音频缓冲
[WS_SEND] 手动创建响应请求
```

这些日志表示手动触发正在工作。

## 💡 最佳实践

### 推荐的使用方式

1. **说话时不要停顿太久**
   - 连续说完整句话
   - 不用担心停顿问题

2. **说完立即按空格**
   - 不需要等待静音检测
   - 主动控制节奏

3. **观察日志**
   - 查看 `result.txt` 确认每一步
   - 检查是否有错误

### 示例对话

```
👤 你：「我想订一张明天去上海的高铁票」
   [按空格键]
   
🤖 AI：「好的，我来帮您查询明天去上海的高铁票...」
   [自动播放语音]
```

## 🐛 故障排查

### 问题 1：按空格键没反应

**检查：**
```bash
grep "\[MANUAL\]" result.txt
```

**可能原因：**
- 键盘监听线程没启动
- 终端焦点不在程序窗口

**解决：**
- 确保终端窗口是当前激活的窗口
- 重启程序

### 问题 2：AI 仍然没有回复

**检查日志流程：**
```bash
# 检查是否发送了手动触发
grep "手动触发" result.txt

# 检查是否收到响应
grep "\[RESPONSE\]" result.txt

# 检查是否有错误
grep "\[ERROR\]" result.txt
```

**可能原因：**
- WebSocket 连接断开
- API 返回错误

### 问题 3：声音听不清

**调整方法：**
1. 音量太小：检查系统音量
2. 语速太快：在代码中调整 `SPEED_MULTIPLIER`（默认1.5）
3. 音质问题：确保使用了 `voice: "female-sweet"`

## 🔧 技术原理

### 工作流程

```
用户说话 → 麦克风录音 → 发送到服务器
     ↓
用户按空格键 → 手动触发
     ↓
发送 commit + create → Server 处理 → AI 回复
```

### 与 Server VAD 的区别

| 模式 | 检测方式 | 优点 | 缺点 |
|------|----------|------|------|
| **Server VAD** | 自动检测静音 | 自然、无需操作 | 受噪音影响 |
| **手动触发** | 用户按键控制 | 可靠、精确控制 | 需要手动按键 |

### 为什么需要手动触发

Server VAD 配置：
- `threshold: 0.5` - 声音强度阈值
- `silence_duration_ms: 700` - 需要 0.7 秒连续静音

在有环境噪音的情况下：
- ❌ 环境噪音让 Server VAD 认为一直有声音
- ❌ 无法满足 0.7 秒连续静音的条件
- ✅ 手动触发绕过了这个限制

## 📝 未来改进

可能的优化方向：
1. 双击空格键确认（避免误触）
2. 语音命令触发（说"完成"）
3. 自适应噪音过滤
4. 更智能的 VAD 配置

---

**🎉 现在就试试手动触发模式吧！**

```bash
python run_with_agent_02.py
```

说话后按空格键，体验更可靠的语音交互！

