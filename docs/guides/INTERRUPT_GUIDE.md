# 智能打断功能使用指南

## 🎯 功能说明

智能打断功能让您可以在 AI 回复时打断它并继续说话，同时通过调整 VAD 参数减少误判。

## ✨ 两大核心功能

### 1. VAD 参数优化 ⭐⭐⭐

**已自动启用，无需配置！**

```python
"turn_detection": {
    "type": "server_vad",
    "threshold": 0.5,              # 音量阈值
    "prefix_padding_ms": 300,      # 说话前缓冲
    "silence_duration_ms": 2000    # 🔑 静默2秒才判定说完
}
```

**效果**：
- ✅ 允许您停顿 **2 秒**来思考
- ✅ 正常换气、停顿不会被打断
- ✅ 大幅减少误判

---

### 2. Enter 键打断 ⭐⭐

**场景**：AI 已经开始回复，但您想继续说话

**操作**：按 `Enter` 键即可

**效果**：
- ✅ 立即停止 AI 回复
- ✅ 清空音频缓冲
- ✅ 您可以继续说话

---

## 🚀 安装依赖

### 必须安装 pynput 库

```bash
pip install pynput
```

或者如果使用虚拟环境：

```bash
source .venv/bin/activate
pip install pynput
```

---

## 💡 使用示例

### 场景 1: 正常对话（无打断）

```
您: "我想买..." [说1秒，停1秒，继续]
    🎤 [正在听...]

您: "...一部手机" [继续说]
    🎤 [正在听...]

您: [停顿2秒+]
    ⏸️ [处理中...]

AI: "好的，推荐您..."
    🔊 [AI 回复中] 按 Enter 继续
```

### 场景 2: 意外被打断

```
您: "我想买手机" [意外停顿超过2秒]
    ⏸️ [处理中...]

AI: "好的，您想要什么价位..."
    🔊 [AI 回复中] 按 Enter 继续

您: [按 Enter] ⚡
    ==================================================
    ⚡ 检测到打断信号！正在停止 AI 回复...
    ==================================================
       ✓ 清空音频缓冲
       ✓ 清空 TTS 队列
       ✓ 已发送取消响应命令
       ✓ 已清空输入音频缓冲
    ✅ AI 已停止，您可以继续说话...
    ==================================================

您: "对了，我还要拍照好的"
    🎤 [正在听...]

AI: "明白了，推荐拍照好的手机..."
```

---

## 🎨 状态指示

### 对话状态提示

| 状态 | 显示 | 说明 |
|------|------|------|
| 监听中 | 🎤 [正在听...] | 可以说话 |
| 处理中 | ⏸️ [处理中...] | 系统处理中 |
| AI 回复 | 🔊 [AI 回复中] 按 Enter 继续 | AI 正在说话，可按 Enter 打断 |

---

## ⚙️ 参数调整

### 如果您觉得 2 秒太短/太长

编辑 `app/realtime.py` 和 `app/realtime_with_agent.py`：

```python
"silence_duration_ms": 2000  # 改为您需要的值（毫秒）
```

**推荐值**：
- **说话快**：1500ms（1.5秒）
- **正常**：2000ms（2秒）⭐ 当前
- **思考多**：2500ms（2.5秒）
- **说话慢**：3000ms（3秒）

### 如果环境噪音大

```python
"threshold": 0.7  # 提高阈值，过滤噪音（默认 0.5）
```

### 如果声音太小被忽略

```python
"threshold": 0.3  # 降低阈值，对小声更敏感（默认 0.5）
```

---

## 🐛 故障排除

### Q1: 按 Enter 没反应

**原因**：pynput 未安装

**解决**：
```bash
pip install pynput
```

### Q2: 终端中看到键盘监听错误

**macOS 用户**：需要授予终端辅助功能权限

1. 打开 **系统偏好设置** > **安全性与隐私** > **隐私**
2. 选择 **辅助功能**
3. 添加您的终端应用（Terminal.app 或 iTerm2）

### Q3: 打断后 AI 还在说话

**原因**：音频缓冲未完全清空

**解决**：功能会自动清空缓冲，如果仍有问题，等待几秒再说话

### Q4: 停顿时间还是太短

**调整参数**：
```python
"silence_duration_ms": 3000  # 改为3秒
```

---

## 📊 功能对比

### 修改前 vs 修改后

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| 停顿容忍 | ~0.5秒 ❌ | 2秒 ✅ |
| 误判率 | 高 ❌ | 低 ✅ |
| 打断能力 | 无 ❌ | 有 ✅ |
| 使用体验 | 需要连续说 | 自然对话 ✅ |

---

## 🎯 使用技巧

### 技巧 1: 正常说话即可

不需要刻意快速说话，2秒停顿足够思考。

### 技巧 2: 用"嗯"、"那个"等词

如果需要更长时间思考，可以说：
```
"我想买... 嗯... 手机"
```

### 技巧 3: 善用 Enter 打断

不确定时直接说，如果 AI 提前回复了，按 Enter 继续说。

### 技巧 4: 观察状态提示

看到 `🎤 [正在听...]` 时可以说话  
看到 `🔊 [AI 回复中]` 时可以按 Enter 打断

---

## 🔧 高级配置

### 完全禁用打断功能

如果不需要打断功能，注释掉键盘监听：

```python
# 注释掉这行
# threading.Thread(target=keyboard_listener_thread, daemon=True).start()
```

### 更改打断按键

编辑 `keyboard_listener_thread` 函数：

```python
# 改为空格键
if key == keyboard.Key.space:
    interrupt_ai_response()

# 改为 Esc 键
if key == keyboard.Key.esc:
    interrupt_ai_response()
```

---

## 📝 更新日志

### v1.0.0 (2025-11-27)
- ✅ 添加 VAD 参数优化（silence_duration_ms: 2000ms）
- ✅ 添加 Enter 键打断功能
- ✅ 添加状态提示
- ✅ 自动清空音频缓冲

---

## 📚 相关文档

- [项目 README](../README.md)
- [Agent 集成指南](./AGENT_INTEGRATION.md)
- [记忆集成指南](./MEMORY_INTEGRATION.md)

---

**祝使用愉快！🎉**

有问题欢迎反馈！

