# 🎤 空格键手动触发功能使用指南

## ✨ 功能说明

已成功将空格键手动触发功能集成到 `run_with_agent.py` 中！

现在你可以：
1. **Server VAD 自动检测**（默认）：说话后停顿 0.7 秒，系统自动识别结束并获取回复
2. **空格键手动触发**（推荐）：说完话立即按空格键，无需等待，立即获取 AI 回复

## 🚀 使用方法

### 启动程序
```bash
python run_with_agent.py
```

### 快捷键说明
- **空格键** = 完成说话，立即请求 AI 回复
- **Enter键** = 打断 AI 回复（当 AI 正在说话时）

### 典型流程
1. 启动程序，看到 `🎤 Ready! Start speaking...`
2. 开始说话：`你好，帮我规划一个北京旅行`
3. 说完后**立即按空格键** ⏸️
4. 系统提示：`[手动触发] 清空音频缓冲并请求响应...`
5. 等待 AI 回复 🎵

## 🔧 技术细节

### 修改的文件
1. **`app/realtime.py`**
   - 添加 `manual_trigger_flag` 全局变量
   - 添加 `manual_trigger_listener_thread()` 函数
   - 修改 `send_audio_loop()` 支持手动触发

2. **`app/realtime_with_agent.py`**
   - 启动手动触发监听线程
   - 更新启动提示信息

### 工作原理
```
用户按下空格键
    ↓
manual_trigger_flag.set()
    ↓
send_audio_loop 检测到标志
    ↓
清空音频队列
    ↓
发送 input_audio_buffer.commit
    ↓
发送 response.create
    ↓
AI 开始生成回复
```

## 💡 使用建议

### 何时使用空格键？
✅ **推荐使用场景：**
- 环境嘈杂，Server VAD 难以准确检测静音
- 需要快速交互，不想等待 0.7 秒静音检测
- 说话中途有自然停顿，但还没说完

❌ **不推荐场景：**
- 环境安静，Server VAD 工作良好
- 不方便操作键盘

### 最佳实践
1. **正常环境**：让 Server VAD 自动检测即可
2. **嘈杂环境**：使用空格键手动触发
3. **连续对话**：结合使用两种方式

## 🐛 故障排除

### 问题：按空格键没反应
**可能原因：**
- AI 正在回复中（此时空格键被禁用）
- 键盘监听线程未启动

**解决方法：**
- 等待 AI 回复完成后再按空格键
- 检查终端是否有 `⌨️  手动触发监听已启动` 提示

### 问题：按空格键后没有收到回复
**可能原因：**
- 没有录制到有效音频
- WebSocket 连接断开

**解决方法：**
- 确保说话时麦克风有输入（观察终端音量提示）
- 检查网络连接

## 🎯 与 Server VAD 的配合

当前配置：
```python
"turn_detection": {
    "type": "server_vad",
    "threshold": 0.5,              # 检测阈值（越低越灵敏）
    "silence_duration_ms": 700,    # 0.7秒静音触发
    "prefix_padding_ms": 300       # 保留说话前 0.3秒
}
```

**建议：**
- 如果发现 Server VAD 经常误触发 → 提高 `threshold` (0.5 → 0.6)
- 如果发现 Server VAD 检测太慢 → 降低 `silence_duration_ms` (700 → 500)
- 如果环境噪音大 → 多用空格键，避免误触发

## 📊 对比

| 特性 | Server VAD | 空格键触发 |
|------|-----------|----------|
| 响应速度 | 需等待 0.7秒 | 立即触发 |
| 便利性 | 无需操作 | 需要按键 |
| 适用场景 | 安静环境 | 嘈杂环境 |
| 准确性 | 依赖环境 | 100%准确 |

## ✅ 测试检查清单

- [ ] 启动程序看到 `手动触发监听已启动`
- [ ] 说话后按空格键
- [ ] 终端显示 `[手动触发] 清空音频缓冲...`
- [ ] 收到 AI 的文字和语音回复
- [ ] Enter键可以打断 AI 回复

---

**如有问题，请查看日志文件：**
- `result.txt`（如果使用 `run_with_agent_02.py` 调试版）
- 终端输出

