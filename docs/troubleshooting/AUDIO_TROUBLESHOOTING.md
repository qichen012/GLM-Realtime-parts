# 🔊 音频播放问题排查指南

## 🚨 问题描述
程序显示 `✅ Playback complete!` 但听不到声音。

## 📊 你的设备信息
- **输入设备**: soundcore Q20i (蓝牙耳机)
- **输出设备**: soundcore Q20i (蓝牙耳机)

## 🔍 快速诊断

### 第一步：运行音频设备测试
```bash
python test_audio_device.py
```

这个脚本会：
1. 列出所有音频设备
2. 测试不同音量级别
3. 专门测试你的 soundcore Q20i
4. 给出诊断建议

### 第二步：检查蓝牙耳机常见问题

#### 问题1：蓝牙耳机模式不对
**症状**: Mac 检测到耳机，但播放没声音
**原因**: 蓝牙耳机可能在"通话模式"而不是"音乐模式"

**解决方法**:
1. 打开 Mac 系统偏好设置 → 声音
2. 查看输出设备列表
3. 如果看到两个 soundcore Q20i：
   - `soundcore Q20i` (音乐模式) ✅
   - `soundcore Q20i (Hands-Free)` (通话模式) ❌
4. 选择非 "Hands-Free" 的那个

#### 问题2：音量太小
**症状**: 有声音但太小听不清

**解决方法**:
1. 调高 Mac 系统音量（F12）
2. 调高耳机本身的音量按钮
3. 已修改代码：音量自动增强到 20000（原来 10000）

#### 问题3：蓝牙连接不稳定
**症状**: 时有时无

**解决方法**:
1. 断开蓝牙重新连接
2. 重启耳机
3. 删除配对重新配对

#### 问题4：输出设备错误
**症状**: 声音输出到了 Mac 扬声器或其他设备

**解决方法**:
1. 按住 Option 键，点击菜单栏音量图标
2. 选择 `soundcore Q20i` 作为输出
3. 或者使用内置扬声器测试

## 🧪 测试方案

### 方案A：使用内置扬声器测试
```bash
# 临时切换到内置扬声器
# 1. 系统偏好设置 → 声音 → 输出 → 选择内置扬声器
# 2. 运行程序
python run_with_agent.py
```

如果内置扬声器有声音，说明：
- ✅ 程序正常
- ❌ 蓝牙耳机有问题

### 方案B：修改代码强制增强音量
已自动完成！新版本会：
- 显示音频数据范围 (max, mean)
- 自动增强音量到 20000
- 显示当前输出设备
- 提供故障排查提示

### 方案C：直接指定输出设备
如果需要强制指定设备，可以修改代码：

```python
# 在 app/realtime.py 的播放部分添加 device 参数
sd.play(full_audio, samplerate=playback_rate, device=DEVICE_ID, blocking=True)
```

## 🔧 已自动优化的改进

### 1. 增强音量输出
```python
TARGET_MAX = 20000  # 从 10000 提高到 20000
volume_boost = min(TARGET_MAX / max_val, 5.0)  # 最大5倍增益
```

### 2. 添加调试信息
```
📊 音频数据: max=8532, mean=1243
🔊 音量增强: 2.34x (max: 8532 → 20000)
🔈 输出设备: soundcore Q20i
⚡ 播放速度: 1.5x
⏱️  时长: 15.63秒
▶️  开始播放...
✅ 播放完成！
💡 如果听不到声音，请检查：
   1. 蓝牙耳机是否已连接
   2. 系统音量是否打开
   3. 耳机音量是否打开
```

## 🎯 立即行动

### 选项1：运行诊断工具（推荐）
```bash
python test_audio_device.py
```

### 选项2：切换到内置扬声器测试
1. 系统偏好设置 → 声音 → 输出
2. 选择"内置扬声器"
3. 运行 `python run_with_agent.py`
4. 如果有声音，说明是蓝牙耳机问题

### 选项3：重新运行程序看新调试信息
```bash
python run_with_agent.py
```

现在会显示详细的音频数据和设备信息。

## 📝 常见问题对照表

| 症状 | 可能原因 | 解决方法 |
|-----|---------|---------|
| 程序显示播放完成，但完全没声音 | 输出设备错误 | 检查系统声音设置 |
| 声音很小很小 | 音量太低 | 调高系统+耳机音量 |
| 有杂音或断断续续 | 蓝牙连接不稳定 | 重新配对蓝牙 |
| 只在内置扬声器有声音 | 蓝牙模式错误 | 切换到音乐模式 |
| test_audio_device.py 有声音，但程序没声音 | 程序音频数据问题 | 查看日志中的音频数据范围 |

## 🆘 如果还是不行

1. **确认启动时的测试音能听到**
   - 程序启动时会播放 "beep" 测试音
   - 如果这个都听不到，肯定是设备问题

2. **查看新的调试信息**
   - 运行 `python run_with_agent.py`
   - 说话后按空格
   - 截图 `📊 音频数据` 那部分的输出

3. **尝试最简单的测试**
   ```bash
   python -c "import sounddevice as sd; import numpy as np; sd.play((np.sin(2*np.pi*440*np.arange(16000)/16000)*20000).astype('int16'), 16000, blocking=True)"
   ```
   如果这个有声音，说明 sounddevice 工作正常。

## ✅ 成功标志

当一切正常时，你会看到：
```
📊 音频数据: max=15234, mean=3421
🔊 音量正常: 15234
🔈 输出设备: soundcore Q20i
⚡ 播放速度: 1.5x
⏱️  时长: 10.59秒
▶️  开始播放...
✅ 播放完成！
```

并且**能清楚听到 AI 的语音回复**。

---

**下一步**: 运行 `python test_audio_device.py` 开始诊断！

