# GLM-Realtime + Claude Code Agent é›†æˆæŒ‡å—

## ğŸ¯ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è¯­éŸ³    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GLM-Realtime API               â”‚
â”‚  â€¢ è¯­éŸ³è¯†åˆ«                      â”‚
â”‚  â€¢ æ„å›¾ç†è§£                      â”‚
â”‚  â€¢ Function Call è¯†åˆ«           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Function Call
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Function Call Handler          â”‚
â”‚  (realtime_with_agent.py)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Claude Code Client             â”‚
â”‚  (claude_code_client.py)        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚         â”‚         â”‚        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â” â”‚
â”‚è¡Œç¨‹è§„åˆ’  â”‚ â”‚è®¢ç¥¨Agentâ”‚ â”‚è®¢é…’åº—   â”‚ â”‚
â”‚Agent    â”‚ â”‚+ Skill â”‚ â”‚Agent   â”‚ â”‚
â”‚         â”‚ â”‚        â”‚ â”‚+ Skill â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
       â”‚         â”‚         â”‚        â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  è¿”å›ç»“æœ       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  GLM è¯­éŸ³å›å¤  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ç”¨æˆ·å¬åˆ°å›å¤  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `function_definitions.py` | Function Call å®šä¹‰ï¼ˆ3ä¸ªæ—…è¡ŒåŠ©æ‰‹åŠŸèƒ½ï¼‰ |
| `claude_code_client.py` | Claude Code å®¢æˆ·ç«¯ï¼Œè°ƒç”¨ sub agent |
| `claude_code_config.py` | é…ç½®æ–‡ä»¶ï¼ˆéœ€è¦æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰ |
| `realtime_with_agent.py` | é›†æˆç‰ˆæœ¬çš„ä¸»ç¨‹åº |

### è¾…åŠ©æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `realtime.py` | åŸå§‹çš„åŸºç¡€ç‰ˆæœ¬ |
| `AGENT_INTEGRATION.md` | æœ¬æ–‡æ¡£ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¡®è®¤åŒä¼´çš„ Claude Code æœåŠ¡

é¦–å…ˆï¼Œä½ éœ€è¦ä»åŒä¼´é‚£é‡Œè·å–ä»¥ä¸‹ä¿¡æ¯ï¼š

#### å¿…éœ€ä¿¡æ¯
- [ ] Claude Code æœåŠ¡çš„ URL åœ°å€ï¼ˆä¾‹å¦‚ï¼š`http://localhost:8000`ï¼‰
- [ ] æ˜¯å¦éœ€è¦ API Key
- [ ] Agent è°ƒç”¨çš„æ¥å£æ ¼å¼

#### æ¥å£æ ¼å¼ç¤ºä¾‹

**æ–¹æ¡ˆ Aï¼šç»Ÿä¸€æ¥å£**
```python
POST /api/agent/execute
{
    "agent_name": "trip_planner",
    "task": "è§„åˆ’åŒ—äº¬æ—…è¡Œ",
    "parameters": {
        "destination": "åŒ—äº¬",
        "start_date": "2024-01-01",
        "end_date": "2024-01-03"
    }
}
```

**æ–¹æ¡ˆ Bï¼šç‹¬ç«‹æ¥å£**
```python
POST /api/trip-planner/execute
{
    "task": "è§„åˆ’åŒ—äº¬æ—…è¡Œ",
    "params": {...}
}
```

### 2. ä¿®æ”¹é…ç½®æ–‡ä»¶

ç¼–è¾‘ `claude_code_config.py`ï¼š

```python
CLAUDE_CODE_CONFIG = {
    "base_url": "http://your-actual-url:8000",  # ğŸ‘ˆ ä¿®æ”¹è¿™é‡Œ
    "api_key": "your-api-key-if-needed",        # ğŸ‘ˆ å¦‚æœéœ€è¦
    ...
}
```

### 3. ä¿®æ”¹å®¢æˆ·ç«¯ä»£ç 

å¦‚æœæ¥å£æ ¼å¼ä¸é»˜è®¤ä¸åŒï¼Œéœ€è¦ä¿®æ”¹ `claude_code_client.py` ä¸­çš„ `_call_agent` æ–¹æ³•ï¼š

```python
def _call_agent(self, agent_name: str, task: str, parameters: Dict[str, Any]):
    # æ ¹æ®å®é™…æ¥å£æ ¼å¼ä¿®æ”¹è¿™é‡Œ
    url = f"{self.base_url}/api/agent/execute"
    payload = {
        "agent_name": agent_name,
        "task": task,
        "parameters": parameters
    }
    # ...
```

### 4. è¿è¡Œæµ‹è¯•

```bash
python realtime_with_agent.py
```

## ğŸ—£ï¸ ä½¿ç”¨ç¤ºä¾‹

### è¡Œç¨‹è§„åˆ’

**ç”¨æˆ·è¯´ï¼š**
> "å¸®æˆ‘è§„åˆ’ä¸€ä¸ª3å¤©çš„åŒ—äº¬æ—…è¡Œï¼Œæˆ‘å–œæ¬¢å†å²æ–‡åŒ–"

**ç³»ç»Ÿæµç¨‹ï¼š**
1. GLMè¯†åˆ«æ„å›¾ â†’ `plan_trip`
2. æå–å‚æ•°ï¼š
   ```json
   {
     "destination": "åŒ—äº¬",
     "start_date": "2024-01-01",
     "end_date": "2024-01-03",
     "preferences": "å†å²æ–‡åŒ–"
   }
   ```
3. è°ƒç”¨è¡Œç¨‹è§„åˆ’ Agent
4. è¿”å›è¡Œç¨‹è§„åˆ’
5. GLM ç”¨è¯­éŸ³å‘Šè¯‰ç”¨æˆ·è§„åˆ’ç»“æœ

### è®¢ç¥¨

**ç”¨æˆ·è¯´ï¼š**
> "æˆ‘è¦è®¢ä¸€å¼ æ˜å¤©ä»åŒ—äº¬åˆ°ä¸Šæµ·çš„é«˜é“ç¥¨"

**ç³»ç»Ÿæµç¨‹ï¼š**
1. GLMè¯†åˆ«æ„å›¾ â†’ `book_ticket`
2. æå–å‚æ•°ï¼š
   ```json
   {
     "ticket_type": "train",
     "departure_city": "åŒ—äº¬",
     "arrival_city": "ä¸Šæµ·",
     "departure_date": "2024-01-02",
     "passenger_count": 1
   }
   ```
3. è°ƒç”¨è®¢ç¥¨ Agent + è®¢ç¥¨ Skill
4. è¿”å›å¯ç”¨è½¦æ¬¡å’Œä»·æ ¼
5. GLM ç”¨è¯­éŸ³å‘Šè¯‰ç”¨æˆ·

### è®¢é…’åº—

**ç”¨æˆ·è¯´ï¼š**
> "å¸®æˆ‘è®¢ä¸€ä¸ªæ­å·çš„å››æ˜Ÿçº§é…’åº—ï¼Œ1æœˆ5å·å…¥ä½ï¼Œ3å¤©"

**ç³»ç»Ÿæµç¨‹ï¼š**
1. GLMè¯†åˆ«æ„å›¾ â†’ `book_hotel`
2. æå–å‚æ•°ï¼š
   ```json
   {
     "city": "æ­å·",
     "check_in_date": "2024-01-05",
     "check_out_date": "2024-01-08",
     "room_count": 1,
     "guest_count": 1,
     "hotel_type": "å››æ˜Ÿ"
   }
   ```
3. è°ƒç”¨è®¢é…’åº— Agent + è®¢é…’åº— Skill
4. è¿”å›å¯ç”¨é…’åº—åˆ—è¡¨
5. GLM ç”¨è¯­éŸ³å‘Šè¯‰ç”¨æˆ·

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. æµ‹è¯• Claude Code è¿æ¥

åˆ›å»ºæµ‹è¯•è„šæœ¬ `test_claude_connection.py`ï¼š

```python
from claude_code_client import claude_code_client

# æµ‹è¯•è¡Œç¨‹è§„åˆ’
result = claude_code_client.plan_trip(
    destination="åŒ—äº¬",
    start_date="2024-01-01",
    end_date="2024-01-03"
)
print("è¡Œç¨‹è§„åˆ’ç»“æœ:", result)

# æµ‹è¯•è®¢ç¥¨
result = claude_code_client.book_ticket(
    ticket_type="train",
    departure_city="åŒ—äº¬",
    arrival_city="ä¸Šæµ·",
    departure_date="2024-01-02",
    passenger_count=1
)
print("è®¢ç¥¨ç»“æœ:", result)
```

### 2. æŸ¥çœ‹å®Œæ•´æ—¥å¿—

åœ¨ `realtime_with_agent.py` ä¸­å·²ç»æ·»åŠ äº†è¯¦ç»†æ—¥å¿—ï¼š

```
ğŸ”” æ”¶åˆ° Function Call: plan_trip
   å‚æ•°: {"destination": "åŒ—äº¬", ...}

ğŸ¤– æ­£åœ¨è°ƒç”¨ Claude Code Agent...
ğŸ“‹ è°ƒç”¨è¡Œç¨‹è§„åˆ’ Agent: ...
   âœ… æ‰§è¡Œå®Œæˆ
   ç»“æœ: {...}
   ğŸ“¤ ç»“æœå·²å‘é€å› GLM
   ğŸ“¤ è¯·æ±‚ GLM ç”Ÿæˆè¯­éŸ³å›å¤
```

### 3. Mock æµ‹è¯•ï¼ˆæ— éœ€ Claude Code æœåŠ¡ï¼‰

ä¸´æ—¶ä¿®æ”¹ `claude_code_client.py`ï¼Œè¿”å›æ¨¡æ‹Ÿæ•°æ®ï¼š

```python
def _call_agent(self, agent_name: str, task: str, parameters: Dict[str, Any]):
    # Mock æ•°æ®ç”¨äºæµ‹è¯•
    return {
        "success": True,
        "result": "è¿™æ˜¯æ¨¡æ‹Ÿçš„ç»“æœ",
        "data": parameters
    }
```

## ğŸ› å¸¸è§é—®é¢˜

### Q1: Function Call æ²¡æœ‰è§¦å‘ï¼Ÿ

**æ£€æŸ¥ï¼š**
1. Tools é…ç½®æ˜¯å¦æ­£ç¡®å‘é€åˆ° GLM
2. ç”¨æˆ·çš„è¯­éŸ³è¾“å…¥æ˜¯å¦æ¸…æ™°
3. GLM æ˜¯å¦è¯†åˆ«å‡ºéœ€è¦è°ƒç”¨å‡½æ•°

**è°ƒè¯•ï¼š**
```python
# åœ¨ on_open_with_agent ä¸­æ·»åŠ 
print("Tools sent to GLM:")
print(json.dumps(tools, ensure_ascii=False, indent=2))
```

### Q2: Claude Code è°ƒç”¨å¤±è´¥ï¼Ÿ

**æ£€æŸ¥ï¼š**
1. URL æ˜¯å¦æ­£ç¡®
2. Claude Code æœåŠ¡æ˜¯å¦è¿è¡Œ
3. ç½‘ç»œæ˜¯å¦è¿é€š
4. æ¥å£æ ¼å¼æ˜¯å¦åŒ¹é…

**è°ƒè¯•ï¼š**
```bash
# ç›´æ¥æµ‹è¯• Claude Code æ¥å£
curl -X POST http://localhost:8000/api/agent/execute \
  -H "Content-Type: application/json" \
  -d '{"agent_name":"trip_planner","task":"æµ‹è¯•","parameters":{}}'
```

### Q3: è¯­éŸ³å›å¤ä¸­æ–­ï¼Ÿ

**åŸå› ï¼š** Function Call æ‰§è¡Œæ—¶é—´è¿‡é•¿

**è§£å†³ï¼š**
```python
# åœ¨ claude_code_client.py ä¸­æ·»åŠ è¶…æ—¶å¤„ç†
response = requests.post(url, json=payload, timeout=30)
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥è°ƒç”¨

```python
import asyncio
import aiohttp

async def _call_agent_async(self, ...):
    async with aiohttp.ClientSession() as session:
        async with session.post(url, json=payload) as response:
            return await response.json()
```

### 2. ç¼“å­˜ç»“æœ

```python
from functools import lru_cache

@lru_cache(maxsize=100)
def get_cached_result(query_key):
    # ç¼“å­˜å¸¸è§æŸ¥è¯¢
    pass
```

### 3. å¹¶å‘å¤„ç†

å¦‚æœéœ€è¦è°ƒç”¨å¤šä¸ª Agentï¼š

```python
import concurrent.futures

with concurrent.futures.ThreadPoolExecutor() as executor:
    futures = [
        executor.submit(agent1.execute),
        executor.submit(agent2.execute)
    ]
    results = [f.result() for f in futures]
```

## ğŸ“ ä¸‹ä¸€æ­¥

1. âœ… æµ‹è¯• Claude Code è¿æ¥
2. âœ… æµ‹è¯•è¯­éŸ³å¯¹è¯
3. âœ… æµ‹è¯• Function Call æµç¨‹
4. â­ ä¼˜åŒ–é”™è¯¯å¤„ç†
5. â­ æ·»åŠ æ›´å¤šåŠŸèƒ½
6. â­ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

## ğŸ¤ ä¸åŒä¼´åä½œ

å»ºè®®ä¸ä½ çš„åŒä¼´ç¡®è®¤ï¼š

1. **æ¥å£æ–‡æ¡£**ï¼šè·å–è¯¦ç»†çš„ API æ–‡æ¡£
2. **æµ‹è¯•ç¯å¢ƒ**ï¼šç¡®ä¿å¯ä»¥è®¿é—®æµ‹è¯•ç¯å¢ƒ
3. **é”™è¯¯æ ¼å¼**ï¼šç»Ÿä¸€é”™è¯¯è¿”å›æ ¼å¼
4. **è¶…æ—¶è®¾ç½®**ï¼šè®¾å®šåˆç†çš„è¶…æ—¶æ—¶é—´
5. **ç›‘æ§æ—¥å¿—**ï¼šåŒæ–¹æ·»åŠ è¯¦ç»†æ—¥å¿—ä¾¿äºè°ƒè¯•

---

**ç¥é›†æˆé¡ºåˆ©ï¼ğŸ‰**

æœ‰é—®é¢˜éšæ—¶æ²Ÿé€šè°ƒæ•´ï¼

