# ğŸ§ª Function Call æµ‹è¯•æŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨ `test_function_call.py` æµ‹è¯• Function Call åŠŸèƒ½ã€‚

## ğŸ“‹ æµ‹è¯•å†…å®¹

### æµ‹è¯• 1: Function å®šä¹‰åŠ è½½
- âœ… éªŒè¯ 3 ä¸ªå‡½æ•°å®šä¹‰æ­£ç¡®åŠ è½½
- âœ… æ£€æŸ¥å‡½æ•°åç§°ï¼š`plan_trip`, `book_ticket`, `book_hotel`
- âœ… éªŒè¯æ¯ä¸ªå‡½æ•°çš„ç»“æ„å®Œæ•´æ€§
- âœ… æµ‹è¯•æŒ‰åç§°è·å–å‡½æ•°
- âœ… æµ‹è¯•ä¸å­˜åœ¨çš„å‡½æ•°å¤„ç†

### æµ‹è¯• 2: Mock Function æ‰§è¡Œ
- âœ… æµ‹è¯• `plan_trip` å‡½æ•°è°ƒç”¨
- âœ… æµ‹è¯• `book_ticket` å‡½æ•°è°ƒç”¨
- âœ… æµ‹è¯• `book_hotel` å‡½æ•°è°ƒç”¨
- âœ… æµ‹è¯•æœªçŸ¥å‡½æ•°çš„é”™è¯¯å¤„ç†

### æµ‹è¯• 3: WebSocket æ¶ˆæ¯å¤„ç†
- âœ… æµ‹è¯•æ¥æ”¶ `response.function_call_arguments.done` æ¶ˆæ¯
- âœ… éªŒè¯ `execute_function_call` è¢«æ­£ç¡®è°ƒç”¨
- âœ… éªŒè¯å‡½æ•°å‚æ•°æ­£ç¡®ä¼ é€’
- âœ… éªŒè¯è¿”å›æ¶ˆæ¯æ ¼å¼æ­£ç¡®
- âœ… éªŒè¯å‘é€ `conversation.item.create` æ¶ˆæ¯
- âœ… éªŒè¯å‘é€ `response.create` æ¶ˆæ¯

### æµ‹è¯• 4: é”™è¯¯å¤„ç†
- âœ… æµ‹è¯•å‚æ•°ç¼ºå¤±çš„å¤„ç†
- âœ… æµ‹è¯•ç½‘ç»œé”™è¯¯çš„å¤„ç†
- âœ… æµ‹è¯• JSON è§£æé”™è¯¯çš„å¤„ç†

### æµ‹è¯• 5: é›†æˆåœºæ™¯æµ‹è¯•
- âœ… åœºæ™¯ 1: å®Œæ•´çš„æ—…è¡Œè§„åˆ’æµç¨‹
- âœ… åœºæ™¯ 2: è¿ç»­è°ƒç”¨å¤šä¸ª function
- âœ… åœºæ™¯ 3: æœåŠ¡å¤±è´¥åçš„å¤„ç†

## ğŸš€ è¿è¡Œæµ‹è¯•

### æ–¹å¼ 1: ç›´æ¥è¿è¡Œ
```bash
cd tests
python test_function_call.py
```

### æ–¹å¼ 2: ä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
```bash
python tests/test_function_call.py
```

### æ–¹å¼ 3: ä½¿ç”¨ pytestï¼ˆå¦‚æœå®‰è£…äº†ï¼‰
```bash
pytest tests/test_function_call.py -v
```

## ğŸ“Š æµ‹è¯•è¾“å‡ºç¤ºä¾‹

```
======================================================================
ğŸš€ Function Call æµ‹è¯•å¼€å§‹
======================================================================

======================================================================
ğŸ§ª æµ‹è¯• 1: Function å®šä¹‰åŠ è½½
======================================================================

âœ… PASS - Test 1: è·å–æ‰€æœ‰å‡½æ•°å®šä¹‰
   ğŸ“ æœŸæœ› 3 ä¸ªå‡½æ•°ï¼Œå®é™… 3 ä¸ª

âœ… PASS - Test 2: å‡½æ•°åç§°æ­£ç¡®
   ğŸ“ å‡½æ•°åˆ—è¡¨: ['plan_trip', 'book_ticket', 'book_hotel']

âœ… PASS - Test 3: å‡½æ•° plan_trip ç»“æ„å®Œæ•´
   ğŸ“ åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ

======================================================================
ğŸ§ª æµ‹è¯• 2: Mock Function æ‰§è¡Œ
======================================================================

âœ… PASS - Test 6: plan_trip å‡½æ•°è°ƒç”¨
   ğŸ“ è¿”å›è¡Œç¨‹: 3 å¤©

âœ… PASS - Test 7: book_ticket å‡½æ•°è°ƒç”¨
   ğŸ“ è®¢ç¥¨æˆåŠŸï¼Œå‚è€ƒå·: MOCK-TK-12345

======================================================================
ğŸ“Š æ€»ä½“æµ‹è¯•æŠ¥å‘Š
======================================================================
æ€»æµ‹è¯•æ•°: 25
âœ… é€šè¿‡: 25
âŒ å¤±è´¥: 0
é€šè¿‡ç‡: 100.0%

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Function Call åŠŸèƒ½æ­£å¸¸ï¼
======================================================================
```

## ğŸ”§ è‡ªå®šä¹‰æµ‹è¯•

### ä½¿ç”¨æµ‹è¯•æ•°æ®æ–‡ä»¶
æµ‹è¯•æ•°æ®ä¿å­˜åœ¨ `test_function_call_data.json` ä¸­ï¼Œä½ å¯ä»¥ï¼š

1. **æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹**ï¼š
```json
{
  "name": "ä½ çš„æµ‹è¯•ç”¨ä¾‹åç§°",
  "function": "plan_trip",
  "arguments": {
    "destination": "æˆéƒ½",
    "start_date": "2024-03-01",
    "end_date": "2024-03-03"
  },
  "expected_result": {
    "success": true,
    "has_itinerary": true
  }
}
```

2. **ä¿®æ”¹ Mock å“åº”**ï¼š
```json
{
  "plan_trip": {
    "success": true,
    "itinerary": ["ä½ çš„è‡ªå®šä¹‰è¡Œç¨‹"],
    "summary": "è‡ªå®šä¹‰æ‘˜è¦"
  }
}
```

### æ‰©å±•æµ‹è¯•è„šæœ¬

åœ¨ `test_function_call.py` ä¸­æ·»åŠ æ–°çš„æµ‹è¯•å‡½æ•°ï¼š

```python
def test_my_custom_scenario():
    """æµ‹è¯• 6: æˆ‘çš„è‡ªå®šä¹‰åœºæ™¯"""
    tester = TestFunctionCall()
    
    print("\n" + "="*70)
    print("ğŸ§ª æµ‹è¯• 6: æˆ‘çš„è‡ªå®šä¹‰åœºæ™¯")
    print("="*70)
    
    # ä½ çš„æµ‹è¯•é€»è¾‘
    # ...
    
    return tester

# åœ¨ main() å‡½æ•°ä¸­æ·»åŠ 
all_testers.append(test_my_custom_scenario())
```

## ğŸ’¡ æµ‹è¯•æŠ€å·§

### 1. åªè¿è¡Œç‰¹å®šæµ‹è¯•
ä¿®æ”¹ `main()` å‡½æ•°ï¼Œæ³¨é‡Šæ‰ä¸éœ€è¦çš„æµ‹è¯•ï¼š

```python
def main():
    all_testers = []
    
    all_testers.append(test_function_definitions())
    # all_testers.append(test_mock_execute_function_call())  # è·³è¿‡è¿™ä¸ª
    all_testers.append(test_websocket_message_handling())
    # ...
```

### 2. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
åœ¨æµ‹è¯•å‡½æ•°ä¸­æ·»åŠ  `print` è¯­å¥ï¼š

```python
print(f"ğŸ” è°ƒè¯•ä¿¡æ¯: {variable}")
```

### 3. æµ‹è¯•çœŸå®çš„ Agent è°ƒç”¨
å¦‚æœä½ æƒ³æµ‹è¯•çœŸå®çš„ Claude Code Agentï¼ˆè€Œä¸æ˜¯ Mockï¼‰ï¼Œå¯ä»¥è¿™æ ·åšï¼š

```python
# æ³¨é‡Šæ‰ @patch è£…é¥°å™¨
# @patch('agents.claude_code_client.ClaudeCodeClient._call_agent')

# ç›´æ¥è°ƒç”¨
result = execute_function_call("plan_trip", {
    "destination": "åŒ—äº¬",
    "start_date": "2024-01-15",
    "end_date": "2024-01-18"
})

print(f"çœŸå® Agent è¿”å›: {result}")
```

**æ³¨æ„**ï¼šæµ‹è¯•çœŸå® Agent éœ€è¦ï¼š
- âœ… Claude Code æœåŠ¡æ­£åœ¨è¿è¡Œ
- âœ… é…ç½®äº†æ­£ç¡®çš„ `CLAUDE_CODE_URL`
- âœ… ç½‘ç»œè¿æ¥æ­£å¸¸

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: å¯¼å…¥é”™è¯¯
```
ModuleNotFoundError: No module named 'agents'
```

**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿ä»æ­£ç¡®çš„ä½ç½®è¿è¡Œï¼š
```bash
cd /Users/xwj/Desktop/gpt-realtime-demo
python tests/test_function_call.py
```

### é—®é¢˜ 2: Mock æ²¡æœ‰ç”Ÿæ•ˆ
```
ConnectionError: Failed to connect to Agent service
```

**åŸå› **ï¼š`@patch` è£…é¥°å™¨çš„è·¯å¾„ä¸æ­£ç¡®ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿ patch çš„æ˜¯å®é™…è°ƒç”¨çš„ä½ç½®ï¼š
```python
@patch('agents.claude_code_client.ClaudeCodeClient._call_agent')
```

### é—®é¢˜ 3: æµ‹è¯•å¤±è´¥
```
âŒ FAIL - Test X: xxx
```

**è°ƒè¯•æ­¥éª¤**ï¼š
1. æŸ¥çœ‹å¤±è´¥çš„æµ‹è¯•åç§°
2. åœ¨æµ‹è¯•å‡½æ•°ä¸­æ·»åŠ  `print` æŸ¥çœ‹ä¸­é—´å˜é‡
3. æ£€æŸ¥ Mock çš„è¿”å›å€¼æ˜¯å¦æ­£ç¡®
4. éªŒè¯æ–­è¨€æ¡ä»¶æ˜¯å¦åˆç†

## ğŸ“ æµ‹è¯•æœ€ä½³å®è·µ

### âœ… åº”è¯¥åšçš„
- æ¯æ¬¡ä¿®æ”¹ Function Call ç›¸å…³ä»£ç åè¿è¡Œæµ‹è¯•
- æ·»åŠ æ–°åŠŸèƒ½æ—¶åŒæ­¥æ·»åŠ æµ‹è¯•ç”¨ä¾‹
- ä½¿ç”¨æœ‰æ„ä¹‰çš„æµ‹è¯•åç§°
- æµ‹è¯•æ­£å¸¸æƒ…å†µå’Œå¼‚å¸¸æƒ…å†µ
- ä¿æŒæµ‹è¯•ç‹¬ç«‹ï¼Œä¸ä¾èµ–å¤–éƒ¨æœåŠ¡

### âŒ ä¸åº”è¯¥åšçš„
- ä¸è¦åœ¨æµ‹è¯•ä¸­ä½¿ç”¨çœŸå®çš„ç”¨æˆ·æ•°æ®
- ä¸è¦è·³è¿‡å¤±è´¥çš„æµ‹è¯•ï¼ˆåº”è¯¥ä¿®å¤ï¼‰
- ä¸è¦è®©æµ‹è¯•ä¾èµ–è¿è¡Œé¡ºåº
- ä¸è¦åœ¨æµ‹è¯•ä¸­ä¿®æ”¹å…¨å±€çŠ¶æ€

## ğŸ¯ æµ‹è¯•è¦†ç›–ç‡

å½“å‰æµ‹è¯•è¦†ç›–çš„åŠŸèƒ½ï¼š

- âœ… Function å®šä¹‰çš„æ­£ç¡®æ€§
- âœ… Function æ‰§è¡Œçš„åŸºæœ¬æµç¨‹
- âœ… WebSocket æ¶ˆæ¯çš„å¤„ç†
- âœ… é”™è¯¯æƒ…å†µçš„å¤„ç†
- âœ… å¤šä¸ª Function è¿ç»­è°ƒç”¨
- âœ… Agent æœåŠ¡å¤±è´¥æ—¶çš„é™çº§

æœªè¦†ç›–çš„åŠŸèƒ½ï¼ˆå¯ä»¥æ‰©å±•ï¼‰ï¼š

- â¸ï¸ ç”¨æˆ·è®°å¿†é›†æˆæµ‹è¯•
- â¸ï¸ å®é™…çš„ç½‘ç»œè¯·æ±‚æµ‹è¯•
- â¸ï¸ å¹¶å‘è°ƒç”¨æµ‹è¯•
- â¸ï¸ æ€§èƒ½æµ‹è¯•

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Agent é›†æˆæŒ‡å—](../docs/integration/AGENT_INTEGRATION.md)
- [Function å®šä¹‰æ–‡ä»¶](../agents/function_definitions.py)
- [Claude Code å®¢æˆ·ç«¯](../agents/claude_code_client.py)

---

**ç¥æµ‹è¯•é¡ºåˆ©ï¼ğŸ‰**

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ [æ•…éšœæ’æŸ¥æŒ‡å—](../docs/troubleshooting/DEBUG_GUIDE.md)ã€‚

